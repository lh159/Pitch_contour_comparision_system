# 音高曲线比对系统实现文档

## 1. 系统概述

### 1.1 系统目标
构建一个中文发音练习与评估系统，该系统能够：
- 根据输入的中文词汇生成标准发音
- 提取标准发音和用户发音的音高曲线
- 对比两个音高曲线，给出发音准确性评估
- 提供可视化的音高曲线对比图表

### 1.2 核心功能
1. **文本转语音（TTS）**：将中文文本转换为标准发音音频
2. **音高提取**：从音频中提取基频（F0）曲线
3. **曲线比对**：计算标准发音与用户发音的相似度
4. **可视化展示**：生成直观的音高曲线对比图
5. **评分系统**：基于比对结果给出量化评分

## 2. 系统架构设计

### 2.1 模块划分

```
音高曲线比对系统
├── 1. TTS模块 (tts_module.py)
├── 2. 音频处理模块 (audio_plot.py - 已有)
├── 3. 音高比对模块 (pitch_comparison.py)
├── 4. 评分算法模块 (scoring_algorithm.py)
├── 5. 可视化模块 (visualization.py)
├── 6. Web界面模块 (web_interface.py)
└── 7. 主控制器 (main_controller.py)
```

### 2.2 数据流程

```
用户输入中文词汇 → TTS生成标准音频 → 提取标准音高曲线
                                    ↓
用户录制发音音频 → 提取用户音高曲线 → 音高曲线比对 → 生成评分和可视化图表
```

## 3. 详细实现方案

### 3.1 TTS模块实现

#### 3.1.1 技术选型
- **主要方案**：百度语音合成API（质量高，性价比好，支持中文）
- **备选方案1**：Edge TTS（免费，质量良好）
- **备选方案2**：PaddleSpeech（离线方案）

#### 3.1.2 实现步骤
1. 注册百度智能云TTS服务API密钥
2. 安装相应依赖：`pip install requests`
3. 创建TTS配置：
   - 语言：zh-CN
   - 语音：度小美（中文女声）
   - 采样率：16kHz
   - 格式：WAV

#### 3.1.3 代码框架
```python
# tts_module.py
import requests

class TTSGenerator:
    def __init__(self, subscription_key, region):
        self.speech_config = speechsdk.SpeechConfig(
            subscription=subscription_key, 
            region=region
        )
        self.speech_config.speech_synthesis_voice_name = "zh-CN-XiaoxiaoNeural"
    
    def generate_standard_audio(self, text, output_path):
        # 生成标准发音音频
        pass
```

### 3.2 音高比对算法

#### 3.2.1 预处理步骤
1. **时间对齐**：使用Dynamic Time Warping (DTW)算法
2. **音高平滑**：去除噪声和异常值
3. **归一化**：统一音高范围和时间长度

#### 3.2.2 比对指标
1. **整体相似度**：皮尔逊相关系数
2. **局部差异**：均方根误差(RMSE)
3. **趋势一致性**：音高变化方向的一致性
4. **音调范围**：音高变化幅度的对比

#### 3.2.3 算法实现
```python
# pitch_comparison.py
import numpy as np
from scipy.stats import pearsonr
from dtaidistance import dtw

class PitchComparator:
    def compare_pitch_curves(self, standard_pitch, user_pitch):
        # 1. 时间对齐
        aligned_user = self.time_align(standard_pitch, user_pitch)
        
        # 2. 计算相似度指标
        correlation = self.calculate_correlation(standard_pitch, aligned_user)
        rmse = self.calculate_rmse(standard_pitch, aligned_user)
        trend_consistency = self.calculate_trend_consistency(standard_pitch, aligned_user)
        
        return {
            'correlation': correlation,
            'rmse': rmse,
            'trend_consistency': trend_consistency
        }
```

### 3.3 评分系统设计

#### 3.3.1 评分维度
1. **音高准确性** (40%权重)
   - 基于皮尔逊相关系数
   - 分数范围：0-100分

2. **音调变化** (30%权重)
   - 基于趋势一致性
   - 考虑声调的正确性

3. **稳定性** (20%权重)
   - 基于RMSE值
   - 评估发音的稳定程度

4. **音域适配** (10%权重)
   - 音高范围的合理性
   - 避免过高或过低

#### 3.3.2 评分算法
```python
# scoring_algorithm.py
class ScoringSystem:
    def calculate_final_score(self, comparison_metrics):
        # 权重配置
        weights = {
            'correlation': 0.4,
            'trend': 0.3,
            'stability': 0.2,
            'range': 0.1
        }
        
        # 计算综合得分
        final_score = (
            comparison_metrics['correlation'] * weights['correlation'] +
            comparison_metrics['trend'] * weights['trend'] +
            comparison_metrics['stability'] * weights['stability'] +
            comparison_metrics['range'] * weights['range']
        ) * 100
        
        return min(100, max(0, final_score))
```

### 3.4 可视化模块扩展

基于现有的`audio_plot.py`，扩展比对可视化功能：

```python
# visualization.py (扩展audio_plot.py)
def plot_pitch_comparison(standard_pitch, user_pitch, output_path, score_info):
    """
    绘制标准发音与用户发音的音高曲线对比图
    """
    fig, ax = plt.subplots(figsize=(15, 8))
    
    # 绘制两条音高曲线
    ax.plot(standard_times, standard_pitch, 'b-', label='标准发音', linewidth=2)
    ax.plot(user_times, user_pitch, 'r-', label='用户发音', linewidth=2)
    
    # 添加评分信息
    score_text = f"总分: {score_info['total']:.1f}分\n相关性: {score_info['correlation']:.3f}\nRMSE: {score_info['rmse']:.2f}Hz"
    ax.text(0.02, 0.98, score_text, transform=ax.transAxes, 
            verticalalignment='top', bbox=dict(boxstyle='round', facecolor='wheat'))
    
    # 设置图表属性
    ax.set_title('音高曲线对比分析', fontsize=16, weight='bold')
    ax.set_xlabel('时间 (秒)', fontsize=12)
    ax.set_ylabel('基频 (Hz)', fontsize=12)
    ax.legend()
    ax.grid(True, alpha=0.3)
    
    plt.tight_layout()
    plt.savefig(output_path, dpi=300, bbox_inches='tight')
    plt.close()
```

### 3.5 Web界面设计

#### 3.5.1 技术栈
- **后端**：Flask/FastAPI
- **前端**：HTML + CSS + JavaScript
- **音频录制**：Web Audio API
- **图表显示**：Chart.js或Plotly.js

#### 3.5.2 界面功能
1. **词汇输入区**：文本输入框
2. **标准发音播放**：音频播放控件
3. **用户录音区**：录音按钮和波形显示
4. **结果展示区**：
   - 音高曲线对比图
   - 评分详情
   - 改进建议

#### 3.5.3 实现框架
```python
# web_interface.py
from flask import Flask, render_template, request, jsonify
import os

app = Flask(__name__)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/generate_standard', methods=['POST'])
def generate_standard():
    text = request.json['text']
    # 调用TTS生成标准音频
    # 返回音频文件路径
    pass

@app.route('/compare_audio', methods=['POST'])
def compare_audio():
    user_audio = request.files['audio']
    standard_path = request.json['standard_path']
    
    # 音高提取和比对
    # 生成可视化图表
    # 返回评分结果
    pass
```

## 4. 实现步骤规划

### 4.1 第一阶段：基础功能开发（1-2周）
1. **TTS模块开发**
   - 集成百度TTS服务
   - 实现中文文本转语音功能
   - 测试音频质量和格式

2. **扩展音频处理模块**
   - 基于现有`audio_plot.py`扩展
   - 添加音高比对函数
   - 实现时间对齐算法

### 4.2 第二阶段：算法优化（1周）
1. **音高比对算法实现**
   - DTW时间对齐
   - 多维度相似度计算
   - 评分算法设计

2. **可视化功能扩展**
   - 双曲线对比图
   - 评分信息展示
   - 美化图表样式

### 4.3 第三阶段：Web界面开发（1-2周）
1. **后端API开发**
   - Flask应用框架
   - 文件上传处理
   - 音频处理接口

2. **前端界面开发**
   - 响应式设计
   - 音频录制功能
   - 实时结果显示

### 4.4 第四阶段：测试与优化（1周）
1. **功能测试**
   - 不同词汇测试
   - 各种发音测试
   - 性能压力测试

2. **用户体验优化**
   - 界面美化
   - 交互流程优化
   - 错误处理完善

## 5. 技术依赖和环境配置

### 5.1 Python包依赖
```txt
# requirements.txt
parselmouth>=0.4.2
numpy>=1.21.0
matplotlib>=3.5.0
scipy>=1.7.0
flask>=2.0.0
pydub>=0.25.1
dtaidistance>=2.3.4
librosa>=0.8.1
scikit-learn>=1.0.0
```

### 5.2 环境配置要求
- Python 3.8+
- 8GB RAM（推荐）
- 支持音频设备的系统
- 网络连接（用于TTS API调用）

### 5.3 API配置
- 百度智能云TTS API密钥
- 百度智能云Secret Key

## 6. 部署方案

### 6.1 本地部署
1. 安装Python环境和依赖包
2. 配置API密钥
3. 运行Flask应用：`python web_interface.py`
4. 浏览器访问：`http://localhost:5000`

### 6.2 云端部署（可选）
1. **Docker容器化**
2. **部署到云平台**（阿里云、AWS等）
3. **CDN加速**音频文件传输

## 7. 扩展功能规划

### 7.1 短期扩展
1. **多语言支持**：英语、粤语等
2. **批量测试**：上传多个词汇进行批量评估
3. **历史记录**：保存用户练习记录
4. **进度追踪**：发音改进趋势分析

### 7.2 长期扩展
1. **AI智能评估**：深度学习模型优化评分算法
2. **个性化建议**：基于用户发音特点给出定制化建议
3. **实时反馈**：录音过程中的实时音高显示
4. **移动端应用**：开发手机APP版本

## 8. 预期效果

### 8.1 功能预期
- 支持常用中文词汇的发音练习
- 提供准确的音高曲线对比
- 给出客观的发音评分（准确率85%+）
- 直观的可视化效果

### 8.2 性能预期
- TTS生成时间：< 3秒
- 音高分析时间：< 5秒
- 总体响应时间：< 10秒
- 支持并发用户：10+

## 9. 风险评估与对策

### 9.1 技术风险
1. **TTS API限制**：配置多个备选方案
2. **音频质量差异**：添加音频预处理和质量检测
3. **算法准确性**：持续优化和大量测试数据验证

### 9.2 成本控制
1. **API调用费用**：设置用量监控和预算限制
2. **存储成本**：定期清理临时音频文件
3. **计算资源**：优化算法效率，减少处理时间

通过以上详细的实现方案，可以构建一个功能完善、用户友好的音高曲线比对系统，有效帮助用户改进中文发音准确性。
