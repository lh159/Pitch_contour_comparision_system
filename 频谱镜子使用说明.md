# 频谱镜子模块 - 使用说明

## 🎉 模块已完成！

频谱镜子模块已成功集成到音高曲线比对系统中。

## 📦 已创建的文件

### 后端文件
1. **spectrogram_analyzer.py** - 核心频谱分析模块
   - 频谱图生成
   - VOT（Voice Onset Time）检测
   - zhi/chi 自动分类
   - 送气强度量化
   - 完整音频分析

2. **web_interface.py** (已更新)
   - 添加了 `/spectrogram_mirror` 页面路由
   - 添加了 4 个 API 端点：
     - `/api/spectrogram/analyze` - 完整分析
     - `/api/spectrogram/classify` - 快速分类
     - `/api/spectrogram/compare` - 与模板对比
     - `/api/spectrogram/vot` - VOT 检测

### 前端文件
3. **templates/spectrogram_mirror.html** - 主页面
   - 响应式设计
   - 三种练习模式（自由、zhi、chi）
   - 实时频谱图显示
   - AI 分析结果展示
   - 练习历史记录

4. **static/js/spectrogram-mirror.js** - 前端逻辑
   - 录音控制
   - Canvas 频谱图绘制
   - 实时数据可视化
   - 本地存储历史

5. **static/css/spectrogram-mirror.css** - 样式表
   - 美观的渐变设计
   - 移动端适配
   - 动画效果

6. **templates/index.html** (已更新)
   - 在主页标题下添加了"频谱镜子"入口链接

## 🚀 启动方法

### 1. 确保依赖已安装

检查 requirements.txt 中的依赖是否已安装：

```bash
pip install librosa numpy scipy matplotlib
```

### 2. 启动系统

```bash
python web_interface.py
```

或使用现有的启动脚本：

```bash
python start.py
```

### 3. 访问频谱镜子

在浏览器中打开：

```
http://localhost:5000/
```

然后点击主页标题下的"频谱镜子"按钮，或直接访问：

```
http://localhost:5000/spectrogram_mirror
```

## 📖 使用教程

### 基础使用流程

1. **选择练习模式**
   - **自由练习**：无特定目标，只显示分析结果
   - **练习 zhi**：系统会根据"不送气音"标准评分
   - **练习 chi**：系统会根据"送气音"标准评分

2. **开始录音**
   - 点击"开始录音"按钮
   - 允许浏览器访问麦克风
   - 清晰地发出目标音（zhi 或 chi）

3. **停止录音**
   - 点击"停止录音"按钮
   - 系统自动开始分析

4. **查看结果**
   - **频谱图**：可视化你的发音特征
     - "瘦条" = 不送气音 (zhi)
     - "胖云" = 送气音 (chi)
   - **识别结果**：系统判定的音素类型和置信度
   - **发音特征**：
     - VOT（送气时长）
     - 送气强度
   - **改进建议**：AI 提供的具体反馈

5. **多次练习**
   - 根据反馈调整发音
   - 历史记录会自动保存
   - 可以对比不同次练习的进步

### 高级功能

#### 显示目标模板
勾选"显示目标模板"后，频谱图上会叠加半透明的目标区域，帮助你瞄准正确的发音模式。

#### 历史记录
- 自动保存最近 20 条练习记录
- 可以查看时间、识别结果、评分等
- 点击"清空记录"可重置历史

## 🎯 核心功能说明

### 1. 频谱图可视化

频谱图将声音的三个维度可视化：
- **X 轴**：时间
- **Y 轴**：频率 (0-8000Hz)
- **颜色**：能量强度（黑→红→黄→白）

### 2. VOT 检测

VOT（Voice Onset Time）是区分送气/不送气音的关键指标：
- **zhi**：VOT < 30ms（短促）
- **chi**：VOT > 60ms（长）

### 3. 送气强度量化

系统会计算：
- 持续时间
- 平均能量
- 高频能量占比（送气主要在高频）
- 频谱平坦度（噪音特征）

综合评分 0-100 分：
- 0-40：弱送气（zhi 特征）
- 60-100：强送气（chi 特征）

### 4. 智能分类

系统综合多个维度进行判断：
- VOT 时长（权重 3）
- 送气强度（权重 2）
- 高频能量（权重 1）

输出：
- 预测结果（zhi 或 chi）
- 置信度（0-100%）
- 详细特征参数

### 5. 评分系统

在指定目标音素的模式下，系统会给出 0-100 分的评分：
- **分类准确性**（40 分）
- **VOT 准确性**（30 分）
- **送气强度**（30 分）

等级：
- **S**：90+ 分（完美）
- **A**：80-89 分（优秀）
- **B**：70-79 分（良好）
- **C**：60-69 分（及格）
- **D**：< 60 分（需改进）

## 🎨 界面说明

### 控制面板
- 模式选择按钮（3 个）
- 模板显示开关

### 录音区域
- 开始/停止录音按钮
- 录音状态指示器

### 频谱图区域
- 实时/静态频谱图显示
- 坐标轴（时间 + 频率）
- 可选的目标模板叠加

### 分析结果区域
- **识别结果卡片**：大字号显示预测音素
- **发音特征卡片**：VOT 和送气强度进度条
- **音素对比卡片**：zhi vs chi 置信度对比
- **改进建议卡片**：AI 生成的具体反馈

### 历史记录区域
- 时间轴展示
- 快速查看关键指标
- 清空记录按钮

## 🔧 技术细节

### 音频参数
- 采样率：16000 Hz
- 通道数：单声道
- FFT 窗口：512
- 帧移：128

### 分类规则

**zhi（不送气音）特征**：
- VOT < 30ms
- 送气强度 < 40
- 高频能量占比低

**chi（送气音）特征**：
- VOT > 60ms
- 送气强度 > 60
- 高频能量占比高（> 30%）

### API 端点

#### 1. 完整分析
```
POST /api/spectrogram/analyze
Content-Type: multipart/form-data

参数：
- audio: 音频文件（WAV）
- target_phoneme: 目标音素（可选，'zhi' 或 'chi'）

返回：
{
  "success": true,
  "spectrogram_data": {...},
  "classification": {...},
  "features": {...},
  "feedback": "...",
  "score": 85.5,
  "grade": "A"
}
```

#### 2. 快速分类
```
POST /api/spectrogram/classify
Content-Type: multipart/form-data

参数：
- audio: 音频文件

返回：
{
  "success": true,
  "prediction": "chi",
  "confidence": 0.95,
  "vot_ms": 75.2,
  ...
}
```

#### 3. 与模板对比
```
POST /api/spectrogram/compare
Content-Type: multipart/form-data

参数：
- audio: 音频文件
- template_type: 模板类型（'zhi' 或 'chi'）

返回：同完整分析
```

#### 4. VOT 检测
```
POST /api/spectrogram/vot
Content-Type: multipart/form-data

参数：
- audio: 音频文件

返回：
{
  "success": true,
  "vot_ms": 65.3,
  "burst_start_time": 0.15,
  "voice_start_time": 0.215
}
```

## 📱 移动端适配

- 响应式设计，自动适配手机/平板
- 触摸优化的按钮和控件
- 简化的移动端布局
- 支持移动设备麦克风录音

## 🐛 常见问题

### Q1: 麦克风无法访问
**A**: 确保：
- 浏览器已授予麦克风权限
- HTTPS 环境（Chrome 要求）
- 没有其他应用占用麦克风

### Q2: 频谱图显示为空
**A**: 可能原因：
- 录音时长太短（建议 > 0.5 秒）
- 音量太小
- 麦克风距离太远

### Q3: 识别结果不准确
**A**: 改进方法：
- 发音更清晰
- 距离麦克风 10-20cm
- 在安静环境录音
- 多练习几次，观察规律

### Q4: 评分总是很低
**A**: 检查：
- 是否选择了正确的练习模式
- 发音是否符合目标特征
- 参考"改进建议"调整

## 🎓 教学建议

### 对比训练法
1. 先练习 zhi，看到"瘦条"
2. 再练习 chi，看到"胖云"
3. 快速切换，强化肌肉记忆

### 模板对照法
1. 开启"显示目标模板"
2. 尝试让自己的频谱图与模板重合
3. 调整送气强度和时长

### 游戏化练习
1. 设定目标：连续 5 次 A 级以上
2. 挑战：zhi-chi-zhi-chi 快速切换
3. 进阶：随机音节混合练习

## 📊 数据说明

### 本地存储
- 历史记录保存在浏览器 localStorage
- 最多保存 20 条记录
- 清除浏览器数据会丢失历史

### 隐私保护
- 音频仅用于实时分析
- 不上传到云端
- 分析完成后立即删除

## 🔮 未来扩展

可以添加的功能：
1. 更多音素对（zh/ch, j/q, z/c）
2. 实时流式分析（边录边显示）
3. 详细的频谱特征教学
4. 练习进度统计图表
5. 多人对比排行榜
6. 导出分析报告

## 📝 开发日志

**2025-10-15**
- ✅ 创建核心频谱分析模块
- ✅ 添加 Web API 路由
- ✅ 实现前端页面和交互
- ✅ Canvas 频谱图可视化
- ✅ AI 分析和反馈系统
- ✅ 历史记录功能
- ✅ 主页入口链接

## 💡 参考文档

详细的技术方案请参考：
- **共振峰频谱图波形表示发音.md** - 完整的理论和实现方案

---

**作者**: AI Assistant  
**版本**: v1.0  
**日期**: 2025-10-15

如有问题，请查看代码注释或联系开发团队。

