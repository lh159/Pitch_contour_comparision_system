<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no, email=no, address=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#17a2b8">
    
    <title>å¬è§‰åé¦ˆè®­ç»ƒ - è¯­è®­å¹³å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/common.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/hearing-feedback.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="text-center mb-3">
                <h2 class="text-info">
                    <i class="fas fa-headphones me-2"></i>
                    å¬è§‰åé¦ˆè®­ç»ƒ
                </h2>
                <button class="btn btn-outline-secondary btn-sm" onclick="window.location.href='/home'">
                    <i class="fas fa-arrow-left me-1"></i>è¿”å›é¦–é¡µ
                </button>
            </div>
            
            <!-- åœºæ™¯ä¿¡æ¯å¡ç‰‡ -->
            <div class="card mb-3 scenario-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-book me-2"></i>
                        <span id="scenarioTitle">åœºæ™¯è®­ç»ƒ</span>
                    </h5>
                    <p class="card-text text-muted" id="scenarioDescription">åŠ è½½ä¸­...</p>
                </div>
            </div>
            
            <!-- è¿›åº¦æ¡ -->
            <div class="progress-section mb-4">
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         id="progressBar" 
                         style="width: 0%;">
                        <span id="progressText">ç¬¬ 0 / 0 å¥</span>
                    </div>
                </div>
            </div>
            
            <!-- éŸ³é¢‘æ’­æ”¾å¡ç‰‡ -->
            <div class="card mb-3 audio-card">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-volume-up me-2"></i>
                        æ’­æ”¾éŸ³é¢‘
                    </h5>
                    
                    <button class="btn btn-primary btn-lg play-btn" id="playBtn">
                        <i class="fas fa-play me-2"></i>
                        æ’­æ”¾éŸ³é¢‘
                    </button>
                    
                    <div class="play-controls mt-3">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">æ’­æ”¾æ¬¡æ•°: <span id="playCount" class="badge bg-secondary">0</span></small>
                            </div>
                            <div class="col-6">
                                <label for="speedControl" class="form-label small">æ’­æ”¾é€Ÿåº¦:</label>
                                <select class="form-select form-select-sm" id="speedControl">
                                    <option value="0.75">0.75x (æ…¢é€Ÿ)</option>
                                    <option value="1" selected>1x (æ­£å¸¸)</option>
                                    <option value="1.25">1.25x (å¿«é€Ÿ)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ–‡å­—è¾“å…¥å¡ç‰‡ -->
            <div class="card mb-3 input-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-keyboard me-2"></i>
                        è¯·è¾“å…¥æ‚¨å¬åˆ°çš„å†…å®¹
                    </h5>
                    
                    <textarea class="form-control form-control-lg" 
                              id="userInput" 
                              rows="4" 
                              placeholder="è¯·åœ¨è¿™é‡Œè¾“å…¥æ‚¨å¬åˆ°çš„æ–‡å­—å†…å®¹..."
                              style="font-size: 1.1rem;"></textarea>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">
                            å­—æ•°: <span id="charCount" class="badge bg-info">0</span>
                        </small>
                        
                        <div>
                            <button class="btn btn-outline-secondary" id="clearBtn">
                                <i class="fas fa-eraser me-2"></i>æ¸…ç©º
                            </button>
                            <button class="btn btn-success ms-2" id="submitBtn">
                                <i class="fas fa-check me-2"></i>æäº¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç»“æœå±•ç¤ºå¡ç‰‡ï¼ˆåˆå§‹éšè—ï¼‰-->
            <div class="card mb-3 result-card" id="resultCard" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title text-center mb-4">
                        <i class="fas fa-chart-line me-2"></i>
                        æ¯”å¯¹ç»“æœ
                    </h5>
                    
                    <!-- å‡†ç¡®ç‡æ˜¾ç¤º -->
                    <div class="text-center mb-4">
                        <div class="accuracy-display">
                            <h2 class="mb-0">
                                å‡†ç¡®ç‡: <span id="accuracyValue" class="text-info">0%</span>
                            </h2>
                        </div>
                    </div>
                    
                    <!-- åŸæ–‡å±•ç¤º -->
                    <div class="mb-3">
                        <h6 class="text-muted">
                            <i class="fas fa-file-alt me-2"></i>åŸæ–‡ï¼š
                        </h6>
                        <div class="original-text p-3 bg-light rounded" id="originalText">
                            <!-- åŸæ–‡å†…å®¹ -->
                        </div>
                    </div>
                    
                    <!-- ç”¨æˆ·è¾“å…¥å±•ç¤ºï¼ˆå¸¦é”™è¯¯æ ‡è®°ï¼‰-->
                    <div class="mb-3">
                        <h6 class="text-muted">
                            <i class="fas fa-pen me-2"></i>æ‚¨çš„è¾“å…¥ï¼š
                        </h6>
                        <div class="user-text p-3 bg-light rounded" id="userText">
                            <!-- ç”¨æˆ·è¾“å…¥å†…å®¹ï¼ˆå¸¦é”™è¯¯æ ‡è®°ï¼‰-->
                        </div>
                    </div>
                    
                    <!-- é”™è¯¯ç»Ÿè®¡ -->
                    <div class="error-stats mb-3" id="errorStats">
                        <!-- é”™è¯¯ç»Ÿè®¡ä¿¡æ¯ -->
                    </div>
                    
                    <!-- æ¿€åŠ±ä¿¡æ¯ -->
                    <div class="feedback-message text-center p-3 rounded" id="feedbackMessage">
                        <!-- æ¿€åŠ±ä¿¡æ¯ -->
                    </div>
                </div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons text-center mb-4">
                <button class="btn btn-outline-info btn-lg me-2" id="replayBtn" disabled>
                    <i class="fas fa-redo me-1"></i>é‡æ–°å¬ä¸€é
                </button>
                <button class="btn btn-info btn-lg" id="nextBtn" style="display: none;">
                    <i class="fas fa-arrow-right me-1"></i>ä¸‹ä¸€å¥
                </button>
                <button class="btn btn-success btn-lg" id="finishBtn" style="display: none;">
                    <i class="fas fa-flag-checkered me-1"></i>å®Œæˆè®­ç»ƒ
                </button>
            </div>
        </div>
    </div>
    
    <!-- å®Œç¾ç­”é¢˜åŠ¨ç”»å®¹å™¨ -->
    <div class="celebration-overlay" id="celebrationOverlay">
        <div class="celebration-content">
            <div class="celebration-icon">ğŸ‰</div>
            <h2 class="celebration-text">å®Œå…¨æ­£ç¡®ï¼</h2>
            <p class="celebration-subtext">å¤ªæ£’äº†ï¼</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- é€šç”¨JS -->
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    
    <!-- å¬è§‰åé¦ˆJS -->
    <script src="{{ url_for('static', filename='js/hearing-feedback.js') }}"></script>
    
    <script>
        // ä»URLå‚æ•°è·å–ä¼šè¯ä¿¡æ¯
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        const dialogueDataStr = urlParams.get('dialogue_data');
        
        if (!sessionId || !dialogueDataStr) {
            showAlert('ç¼ºå°‘è®­ç»ƒæ•°æ®ï¼Œè¯·ä»é¦–é¡µé‡æ–°å¼€å§‹', 'danger');
            setTimeout(() => {
                window.location.href = '/home';
            }, 2000);
        } else {
            try {
                const dialogueData = JSON.parse(dialogueDataStr);
                
                // åˆå§‹åŒ–å¬è§‰åé¦ˆè®­ç»ƒå™¨
                const trainer = new HearingFeedbackTrainer(sessionId, dialogueData);
                trainer.start();
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showAlert('æ•°æ®è§£æå¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
            }
        }
    </script>
</body>
</html>

