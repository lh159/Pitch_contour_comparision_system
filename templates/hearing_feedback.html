<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no, email=no, address=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#17a2b8">
    
    <title>Âê¨ËßâÂèçÈ¶àËÆ≠ÁªÉ - ËØ≠ËÆ≠Âπ≥Âè∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/common.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/hearing-feedback.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- È°µÈù¢Ê†áÈ¢ò -->
            <div class="text-center mb-3">
                <h2 class="text-info">
                    <i class="fas fa-headphones me-2"></i>
                    Âê¨ËßâÂèçÈ¶àËÆ≠ÁªÉ
                </h2>
            </div>
            
            <!-- Âú∫ÊôØ‰ø°ÊÅØÂç°Áâá -->
            <div class="card mb-3 scenario-card">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        <i class="fas fa-book me-2"></i>
                        <span id="scenarioTitle">Âú∫ÊôØËÆ≠ÁªÉ</span>
                    </h5>
                </div>
            </div>
            
            <!-- ËøõÂ∫¶Êù° -->
            <div class="progress-section mb-4">
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         id="progressBar" 
                         style="width: 0%;">
                        <span id="progressText">Á¨¨ 0 / 0 Âè•</span>
                    </div>
                </div>
            </div>
            
            <!-- Èü≥È¢ëÊí≠ÊîæÂç°Áâá -->
            <div class="card mb-3 audio-card">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-volume-up me-2"></i>
                        Êí≠ÊîæÈü≥È¢ë
                    </h5>
                    
                    <button class="btn btn-primary btn-lg play-btn" id="playBtn">
                        <i class="fas fa-play me-2"></i>
                        Êí≠ÊîæÈü≥È¢ë
                    </button>
                    
                    <div class="play-controls mt-3">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Êí≠ÊîæÊ¨°Êï∞: <span id="playCount" class="badge bg-secondary">0</span></small>
                            </div>
                            <div class="col-6">
                                <label for="speedControl" class="form-label small">Êí≠ÊîæÈÄüÂ∫¶:</label>
                                <select class="form-select form-select-sm" id="speedControl">
                                    <option value="0.75">0.75x (ÊÖ¢ÈÄü)</option>
                                    <option value="1" selected>1x (Ê≠£Â∏∏)</option>
                                    <option value="1.25">1.25x (Âø´ÈÄü)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ÊñáÂ≠óËæìÂÖ•Âç°Áâá -->
            <div class="card mb-3 input-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-keyboard me-2"></i>
                        ËØ∑ËæìÂÖ•ÊÇ®Âê¨Âà∞ÁöÑÂÜÖÂÆπ
                    </h5>
                    
                    <textarea class="form-control form-control-lg" 
                              id="userInput" 
                              rows="4" 
                              placeholder="ËØ∑Âú®ËøôÈáåËæìÂÖ•ÊÇ®Âê¨Âà∞ÁöÑÊñáÂ≠óÂÜÖÂÆπ..."
                              style="font-size: 1.1rem;"></textarea>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">
                            Â≠óÊï∞: <span id="charCount" class="badge bg-info">0</span>
                        </small>
                        
                        <div>
                            <button class="btn btn-outline-secondary" id="clearBtn">
                                <i class="fas fa-eraser me-2"></i>Ê∏ÖÁ©∫
                            </button>
                            <button class="btn btn-success ms-2" id="submitBtn">
                                <i class="fas fa-check me-2"></i>Êèê‰∫§
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ÁªìÊûúÂ±ïÁ§∫Âç°ÁâáÔºàÂàùÂßãÈöêËóèÔºâ-->
            <div class="card mb-3 result-card" id="resultCard" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title text-center mb-4">
                        <i class="fas fa-chart-line me-2"></i>
                        ÊØîÂØπÁªìÊûú
                    </h5>
                    
                    <!-- ÂáÜÁ°ÆÁéáÊòæÁ§∫ -->
                    <div class="text-center mb-4">
                        <div class="accuracy-display">
                            <h2 class="mb-0">
                                ÂáÜÁ°ÆÁéá: <span id="accuracyValue" class="text-info">0%</span>
                            </h2>
                        </div>
                    </div>
                    
                    <!-- ÂéüÊñáÂ±ïÁ§∫ -->
                    <div class="mb-3">
                        <h6 class="text-muted">
                            <i class="fas fa-file-alt me-2"></i>ÂéüÊñáÔºö
                        </h6>
                        <div class="original-text p-3 bg-light rounded" id="originalText">
                            <!-- ÂéüÊñáÂÜÖÂÆπ -->
                        </div>
                    </div>
                    
                    <!-- Áî®Êà∑ËæìÂÖ•Â±ïÁ§∫ÔºàÂ∏¶ÈîôËØØÊ†áËÆ∞Ôºâ-->
                    <div class="mb-3">
                        <h6 class="text-muted">
                            <i class="fas fa-pen me-2"></i>ÊÇ®ÁöÑËæìÂÖ•Ôºö
                        </h6>
                        <div class="user-text p-3 bg-light rounded" id="userText">
                            <!-- Áî®Êà∑ËæìÂÖ•ÂÜÖÂÆπÔºàÂ∏¶ÈîôËØØÊ†áËÆ∞Ôºâ-->
                        </div>
                    </div>
                    
                    <!-- ÈîôËØØÁªüËÆ° -->
                    <div class="error-stats mb-3" id="errorStats">
                        <!-- ÈîôËØØÁªüËÆ°‰ø°ÊÅØ -->
                    </div>
                    
                    <!-- ÊøÄÂä±‰ø°ÊÅØ -->
                    <div class="feedback-message text-center p-3 rounded" id="feedbackMessage">
                        <!-- ÊøÄÂä±‰ø°ÊÅØ -->
                    </div>
                </div>
            </div>
            
            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <div class="action-buttons text-center mb-4">
                <button class="btn btn-outline-info btn-lg me-2" id="replayBtn" disabled>
                    <i class="fas fa-redo me-1"></i>ÈáçÊñ∞Âê¨‰∏ÄÈÅç
                </button>
                <button class="btn btn-info btn-lg" id="nextBtn" style="display: none;">
                    <i class="fas fa-arrow-right me-1"></i>‰∏ã‰∏ÄÂè•
                </button>
                <button class="btn btn-success btn-lg" id="finishBtn" style="display: none;">
                    <i class="fas fa-flag-checkered me-1"></i>ÂÆåÊàêËÆ≠ÁªÉ
                </button>
            </div>
        </div>
    </div>
    
    <!-- ÂÆåÁæéÁ≠îÈ¢òÂä®ÁîªÂÆπÂô® -->
    <div class="celebration-overlay" id="celebrationOverlay">
        <div class="celebration-content">
            <div class="celebration-icon">üéâ</div>
            <h2 class="celebration-text">ÂÆåÂÖ®Ê≠£Á°ÆÔºÅ</h2>
            <p class="celebration-subtext">Â§™Ê£í‰∫ÜÔºÅ</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- ÈÄöÁî®JS -->
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    
    <!-- Âê¨ËßâÂèçÈ¶àJS -->
    <script src="{{ url_for('static', filename='js/hearing-feedback.js') }}?v=2.0"></script>
    
    <script>
        // Ê£ÄÊü• SweetAlert2 ÊòØÂê¶Âä†ËΩΩÊàêÂäü
        if (typeof Swal === 'undefined') {
            console.warn('‚ö†Ô∏è SweetAlert2 Êú™ËÉΩÂä†ËΩΩÔºåÂ∞Ü‰ΩøÁî®ÂéüÁîüÂØπËØùÊ°Ü‰Ωú‰∏∫ÂõûÈÄÄÊñπÊ°à');
        } else {
            console.log('‚úÖ SweetAlert2 Â∑≤ÊàêÂäüÂä†ËΩΩ');
        }
        
        // ‰ªéURLÂèÇÊï∞Ëé∑Âèñ‰ºöËØù‰ø°ÊÅØ
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        const dialogueDataStr = urlParams.get('dialogue_data');
        
        if (!sessionId || !dialogueDataStr) {
            showAlert('Áº∫Â∞ëËÆ≠ÁªÉÊï∞ÊçÆÔºåËØ∑‰ªéÈ¶ñÈ°µÈáçÊñ∞ÂºÄÂßã', 'danger');
            setTimeout(() => {
                window.location.href = '/home';
            }, 2000);
        } else {
            try {
                const dialogueData = JSON.parse(dialogueDataStr);
                
                // ÂàùÂßãÂåñÂê¨ËßâÂèçÈ¶àËÆ≠ÁªÉÂô®
                const trainer = new HearingFeedbackTrainer(sessionId, dialogueData);
                trainer.start();
            } catch (error) {
                console.error('ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                showAlert('Êï∞ÊçÆËß£ÊûêÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'danger');
            }
        }
    </script>
</body>
</html>

